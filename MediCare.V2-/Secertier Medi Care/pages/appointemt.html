<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Admin - Rendez-vous</title>
  <script src="https://kit.fontawesome.com/a2e0e6b6f5.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
  <div class="flex h-screen">
    
    <!-- SIDEBAR -->
    <div id="sidebar" class="w-64 bg-white dark:bg-gray-800 shadow-lg transform transition-transform duration-300 md:translate-x-0 -translate-x-full fixed md:relative z-20 h-full">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
    
                <h1 class="text-xl font-bold text-blue-600 dark:text-blue-400">Dashboard Admin</h1>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Secr√©taire (admin)</p>
            </div>
            
            <nav class="mt-6">
                <div class="px-6 py-3 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <a href="dashboard.html" class="flex items-center text-gray-700 dark:text-gray-300">
                        <i class="fas fa-tachometer-alt w-5 mr-3"></i>
                        <span>Tableau de bord</span>
                    </a>
                </div>
                
                <div class="px-6 py-3 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <a href="med.html" class="flex items-center text-gray-700 dark:text-gray-300">
                        <i class="fas fa-user-md w-5 mr-3"></i>
                        <span>M√©decins</span>
                    </a>
                </div>
                
                <div class="px-6 py-3 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <a href="specialiti.html" class="flex items-center text-gray-700 dark:text-gray-300">
                        <i class="fas fa-calendar-alt w-5 mr-3"></i>
                        <span>Sp√©cialit√©s</span>
                    </a>
                </div>
                
                <div class="px-6 py-3 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <a href="desponabilite.html" class="flex items-center text-gray-700 dark:text-gray-300">
                        <i class="fas fa-users w-5 mr-3"></i>
                        <span>Disponibilit√©s</span>
                    </a>
                </div>
                
                <div class="px-6 py-3 bg-blue-50 dark:bg-gray-700 border-r-4 border-blue-500">
                    <a href="#" class="flex items-center text-blue-600 dark:text-blue-400">
                        <i class="fas fa-file-medical w-5 mr-3"></i>
                        <span>Rendez-vous</span>
                    </a>
                </div>
                
            </nav>
            
            <div class="absolute bottom-0 w-full p-6 border-t border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-gray-700 dark:text-gray-300">Mode Sombre</span>
                    <button onclick="toggleDarkMode()" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-300 dark:bg-gray-600 transition-colors">
                        <span class="inline-block h-4 w-4 transform bg-white rounded-full transition-transform translate-x-1 dark:translate-x-6"></span>
                    </button>
                </div>
                
                <button id="desconectBtn" class="flex items-center text-red-500 w-full py-2 px-4 rounded-lg hover:bg-red-50 dark:hover:bg-gray-700 transition-colors" >
                    <i class="fas fa-sign-out-alt w-5 mr-3"></i>
                    <span>D√©connexion</span>
                </button>
            </div>
        </div>

    <!-- CONTENU PRINCIPAL -->
    <main class="flex-1 p-8 overflow-y-auto">
      <div class="flex justify-between items-center mb-8">
        <div>
          <h2 class="text-3xl font-semibold text-gray-800 dark:text-gray-100">Gestion des Rendez-vous</h2>
          <p class="text-gray-500 dark:text-gray-400">Consultez et g√©rez tous les rendez-vous</p>
        </div>
      </div>

      <!-- STATISTIQUES -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 dark:text-gray-400 text-sm">Total</p>
              <p id="stat-total" class="text-3xl font-bold text-gray-800 dark:text-gray-100">0</p>
            </div>
            <i class="fas fa-calendar text-4xl text-blue-500"></i>
          </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 dark:text-gray-400 text-sm">En attente</p>
              <p id="stat-attente" class="text-3xl font-bold text-yellow-600">0</p>
            </div>
            <i class="fas fa-clock text-4xl text-yellow-500"></i>
          </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 dark:text-gray-400 text-sm">Valid√©s</p>
              <p id="stat-valides" class="text-3xl font-bold text-green-600">0</p>
            </div>
            <i class="fas fa-check-circle text-4xl text-green-500"></i>
          </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 dark:text-gray-400 text-sm">Annul√©s</p>
              <p id="stat-annules" class="text-3xl font-bold text-red-600">0</p>
            </div>
            <i class="fas fa-times-circle text-4xl text-red-500"></i>
          </div>
        </div>
      </div>

      <!-- FILTRES -->
      <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm mb-8">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">
          <i class="fas fa-filter mr-2"></i>Filtres
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <input 
            type="text" 
            id="filtrePatient"
            placeholder="Nom du patient..." 
            onkeyup="appliquerFiltres()"
            class="p-3 border border-gray-300 dark:border-gray-700 rounded-lg w-full focus:ring-2 focus:ring-blue-400 outline-none dark:bg-gray-900 dark:text-gray-200">

          <select id="filtreMedecin" onchange="appliquerFiltres()" class="p-3 border border-gray-300 dark:border-gray-700 rounded-lg w-full focus:ring-2 focus:ring-blue-400 dark:bg-gray-900 dark:text-gray-200">
            <option value="">Tous les m√©decins</option>
          </select>

          <select id="filtreStatut" onchange="appliquerFiltres()" class="p-3 border border-gray-300 dark:border-gray-700 rounded-lg w-full focus:ring-2 focus:ring-blue-400 dark:bg-gray-900 dark:text-gray-200">
            <option value="">Tous les statuts</option>
            <option value="en attente">En attente</option>
            <option value="valid√©">Valid√©</option>
            <option value="annul√©">Annul√©</option>
          </select>

          <input 
            type="date" 
            id="filtreDate"
            onchange="appliquerFiltres()"
            class="p-3 border border-gray-300 dark:border-gray-700 rounded-lg w-full focus:ring-2 focus:ring-blue-400 dark:bg-gray-900 dark:text-gray-200">
        </div>

        <button onclick="reinitialiserFiltres()" class="mt-4 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
          <i class="fas fa-redo mr-2"></i>R√©initialiser les filtres
        </button>
      </div>

      <!-- LISTE DES RENDEZ-VOUS -->
      <div id="listeRendezVous" class="space-y-4">
        <!-- Les rendez-vous vont appara√Ætre ici -->
      </div>

      <!-- MESSAGE SI VIDE -->
      <div id="messageVide" class="bg-white dark:bg-gray-800 p-12 rounded-xl shadow-sm text-center hidden">
        <i class="fas fa-calendar-times text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
        <p class="text-gray-500 dark:text-gray-400 text-lg mb-4">Aucun rendez-vous trouv√©</p>
        <button onclick="reinitialiserFiltres()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
          R√©initialiser les filtres
        </button>
      </div>
    </main>
  </div>

  <!-- MODAL REPROGRAMMATION -->
  <div id="modalReprogrammer" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
      <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">
        <i class="fas fa-calendar-alt mr-2 text-blue-500"></i>Reprogrammer le rendez-vous
      </h3>
      
      <div class="space-y-4 mb-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nouvelle date</label>
          <input type="date" id="nouvelleDate" class="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-400 outline-none dark:bg-gray-900 dark:text-gray-200">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nouvelle heure</label>
          <input type="time" id="nouvelleHeure" class="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-400 outline-none dark:bg-gray-900 dark:text-gray-200">
        </div>
      </div>

      <div class="flex gap-3">
        <button onclick="confirmerReprogrammation()" class="flex-1 px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
          <i class="fas fa-check mr-2"></i>Confirmer
        </button>
        <button onclick="fermerModal()" class="flex-1 px-4 py-3 bg-gray-300 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition-colors">
          <i class="fas fa-times mr-2"></i>Annuler
        </button>
      </div>
    </div>
  </div>

  <script>
    tailwind.config = {
            darkMode: 'class',
        }
        
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
        }
    // ========================================
    //  CHARGER LES RENDEZ-VOUS DU LOCALSTORAGE
    // ========================================
    function chargerRendezVous() {
      let appointments = JSON.parse(localStorage.getItem("appointments")) || [];
      let doctors = JSON.parse(localStorage.getItem("doctors info")) || [];
      
      // Convertir les rendez-vous utilisateur en format admin
      let rendezvous = appointments.map((app, index) => {
        let doctor = doctors.find(d => d.id === parseInt(app.doctor));
        return {
          id: index + 1,
          patient: app.name,
          email: app.email,
          phone: app.phone,
          medecin: doctor ? doctor.nom : "Dr. Inconnu",
          specialite: doctor ? doctor.special : "Sp√©cialit√© inconnue",
          date: app.day,
          status: app.status,
          reason: app.reason
        };
      });
      
      return rendezvous;
    }

    let rendezvous = chargerRendezVous();
    let rdvEnCoursReprogrammation = null;

    // ========================================
    //  FONCTION : AFFICHER LES RENDEZ-VOUS
    // ========================================
    function afficherRendezVous(liste = rendezvous) {
      let zone = document.getElementById('listeRendezVous');
      let messageVide = document.getElementById('messageVide');

      zone.innerHTML = '';

      if (liste.length === 0) {
        zone.classList.add('hidden');
        messageVide.classList.remove('hidden');
        return;
      }

      zone.classList.remove('hidden');
      messageVide.classList.add('hidden');

      // Trier par date et heure
      liste.sort((a, b) => {
        let dateA = new Date(a.date + ' ' + a.heure);
        let dateB = new Date(b.date + ' ' + a.heure);
        return dateA - dateB;
      }); 

      liste.forEach(rdv => {
        let carte = document.createElement('div');
        
        let couleurStatut = '';
        let iconeStatut = '';
        let bgStatut = '';
        
        if (rdv.status === 'valid√©') {
          couleurStatut = 'text-green-600';
          iconeStatut = 'fa-check-circle';
          bgStatut = 'bg-green-50 dark:bg-green-900/20';
        } else if (rdv.status === 'annul√©') {
          couleurStatut = 'text-red-600';
          iconeStatut = 'fa-times-circle';
          bgStatut = 'bg-red-50 dark:bg-red-900/20';
        } else {
          couleurStatut = 'text-yellow-600';
          iconeStatut = 'fa-clock';
          bgStatut = 'bg-yellow-50 dark:bg-yellow-900/20';
        }
        
        carte.className = 'bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm hover:shadow-lg transition-all duration-300';
        
        carte.innerHTML = `
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <!-- INFORMATIONS -->
            <div class="flex-1 space-y-3">
              <div class="flex items-center gap-3">
                <i class="fas ${iconeStatut} text-2xl ${couleurStatut}"></i>
                <div>
                  <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">${rdv.patient}</h3>
                  <span class="text-xs px-2 py-1 rounded-full ${bgStatut} ${couleurStatut} font-medium">
                    ${rdv.status.toUpperCase()}
                  </span>
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div class="flex items-center text-gray-600 dark:text-gray-300">
                  <i class="fas fa-user-md w-5 text-gray-400 mr-2"></i>
                  <span><strong>M√©decin:</strong> ${rdv.medecin}</span>
                </div>
                
                <div class="flex items-center text-gray-600 dark:text-gray-300">
                  <i class="fas fa-stethoscope w-5 text-gray-400 mr-2"></i>
                  <span><strong>Sp√©cialit√©:</strong> ${rdv.special}</span>
                </div>
                
                <div class="flex items-center text-gray-600 dark:text-gray-300">
                  <i class="fas fa-calendar w-5 text-gray-400 mr-2"></i>
                  <span><strong>Date:</strong> ${formatDate(rdv.day)}</span>
                </div>
                
                
                
                ${rdv.reason ? `
                <div class="flex items-center text-gray-600 dark:text-gray-300 col-span-2">
                  <i class="fas fa-notes-medical w-5 text-gray-400 mr-2"></i>
                  <span><strong>Raison:</strong> ${rdv.reason}</span>
                </div>
                ` : ''}
              </div>
            </div>

            <!-- ACTIONS -->
            <div class="flex md:flex-col gap-2">
              <button 
                onclick="changerStatus(${rdv.id}, 'valid√©')" 
                class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm ${rdv.status === 'valid√©' ? 'opacity-50 cursor-not-allowed' : ''}"
                ${rdv.status === 'valid√©' ? 'disabled' : ''}
              >
                <i class="fas fa-check mr-1"></i>Valider
              </button>
              
              <button 
                onclick="changerStatus(${rdv.id}, 'annul√©')" 
                class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm ${rdv.status === 'annul√©' ? 'opacity-50 cursor-not-allowed' : ''}"
                ${rdv.status === 'annul√©' ? 'disabled' : ''}
              >
                <i class="fas fa-times mr-1"></i>Annuler
              </button>
              
              <button 
                onclick="ouvrirModalReprogrammer(${rdv.id})" 
                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm"
              >
                <i class="fas fa-calendar-alt mr-1"></i>Reprogrammer
              </button>
            </div>
          </div>
        `;
        
        zone.appendChild(carte);
      });

      mettreAJourStatistiques(liste);
    }

    // ========================================
    //  FONCTION : METTRE √Ä JOUR LES STATS
    // ========================================
    function mettreAJourStatistiques(liste) {
      document.getElementById('stat-total').textContent = liste.length;
      document.getElementById('stat-attente').textContent = liste.filter(r => r.status === 'en attente').length;
      document.getElementById('stat-valides').textContent = liste.filter(r => r.status === 'valid√©').length;
      document.getElementById('stat-annules').textContent = liste.filter(r => r.status === 'annul√©').length;
    }

    // ========================================
    //  FONCTION : CHANGER LE STATUS
    // ========================================
    function changerStatus(id, nouveauStatus) {
      let rdv = rendezvous.find(r => r.id === id);
      if (rdv) {
        rdv.status = nouveauStatus;
        
        // Mettre √† jour dans localStorage
        let appointments = JSON.parse(localStorage.getItem("appointments")) || [];
        let index = id - 1;
        if (appointments[index]) {
          appointments[index].status = nouveauStatus;
          localStorage.setItem("appointments", JSON.stringify(appointments));
        }
        
        appliquerFiltres();
      }
    }

    // ========================================
    //  FONCTION : APPLIQUER LES FILTRES
    // ========================================
    function appliquerFiltres() {
      let filtrePatient = document.getElementById('filtrePatient').value.toLowerCase();
      let filtreMedecin = document.getElementById('filtreMedecin').value;
      let filtreStatut = document.getElementById('filtreStatut').value;
      let filtreDate = document.getElementById('filtreDate').value;

      let resultat = rendezvous.filter(rdv => {
        let matchPatient = rdv.patient.toLowerCase().includes(filtrePatient);
        let matchMedecin = !filtreMedecin || rdv.medecin === filtreMedecin;
        let matchStatut = !filtreStatut || rdv.status === filtreStatut;
        let matchDate = !filtreDate || rdv.date === filtreDate;

        return matchPatient && matchMedecin && matchStatut && matchDate;
      });

      afficherRendezVous(resultat);
    }

    // ========================================
    //  FONCTION : R√âINITIALISER LES FILTRES
    // ========================================
    function reinitialiserFiltres() {
      document.getElementById('filtrePatient').value = '';
      document.getElementById('filtreMedecin').value = '';
      document.getElementById('filtreStatut').value = '';
      document.getElementById('filtreDate').value = '';
      afficherRendezVous();
    }

    // ========================================
    //  FONCTION : OUVRIR MODAL REPROGRAMMER
    // ========================================
    function ouvrirModalReprogrammer(id) {
      rdvEnCoursReprogrammation = id;
      let rdv = rendezvous.find(r => r.id === id);
      
      document.getElementById('nouvelleDate').value = rdv.day;
      document.getElementById('nouvelleHeure').value = rdv.heure;
      document.getElementById('modalReprogrammer').classList.remove('hidden');
    }

    // ========================================
    //  FONCTION : CONFIRMER REPROGRAMMATION
    // ========================================
    function confirmerReprogrammation() {
      let nouvelleDate = document.getElementById('nouvelleDate').value;
      let nouvelleHeure = document.getElementById('nouvelleHeure').value;

      if (!nouvelleDate || !nouvelleHeure) {
        alert('Veuillez remplir tous les champs');
        return;
      }

      let rdv = rendezvous.find(r => r.id === rdvEnCoursReprogrammation);
      if (rdv) {
        rdv.day = nouvelleDate;
        rdv.heure = nouvelleHeure;
        rdv.status = 'en attente';
        
        // Mettre √† jour dans localStorage
        let appointments = JSON.parse(localStorage.getItem("appointments")) || [];
        let index = rdvEnCoursReprogrammation - 1;
        if (appointments[index]) {
          appointments[index].day = nouvelleDate;
          appointments[index].time = nouvelleHeure;
          appointments[index].status = 'en attente';
          localStorage.setItem("appointments", JSON.stringify(appointments));
        }
      }

      fermerModal();
      appliquerFiltres();
    }

    // ========================================
    //  FONCTION : FERMER MODAL
    // ========================================
    function fermerModal() {
      document.getElementById('modalReprogrammer').classList.add('hidden');
      rdvEnCoursReprogrammation = null;
    }

    // ========================================
    //  FONCTION : FORMATER LA DATE
    // ========================================
    function formatDate(dateStr) {
      let date = new Date(dateStr);
      let options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      return date.toLocaleDateString('fr-FR', options);
    }

    // ========================================
    //  FONCTION : REMPLIR LISTE M√âDECINS
    // ========================================
    function remplirListeMedecins() {
      let medecins = [...new Set(rendezvous.map(r => r.medecin))];
      let select = document.getElementById('filtreMedecin');
      
      medecins.forEach(medecin => {
        let option = document.createElement('option');
        option.value = medecin;
        option.textContent = medecin;
        select.appendChild(option);
      });
    }

    // ========================================
    //  FONCTION : MODE SOMBRE
    // ========================================
    function toggleDarkMode() {
      document.documentElement.classList.toggle('dark');
    }

    // ========================================
    // FONCTION : RAFRA√éCHIR LES DONN√âES
    // ========================================
    function rafraichirDonnees() {
      rendezvous = chargerRendezVous();
      appliquerFiltres();
    }

    setInterval(rafraichirDonnees, 2000);


    // ========================================
    // üöÄ INITIALISATION
    // ========================================
    remplirListeMedecins();
    afficherRendezVous();
    
    // Rafra√Æchir les donn√©es toutes les 2 secondes pour voir les nouveaux RDV
    // setInterval(rafraichirDonnees, 2000);

    function toggleSidebar() {
            const overlay = document.getElementById('overlay')
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        const DesBtn = document.getElementById("desconectBtn");
        DesBtn.addEventListener('click', function desconectF(){
            window.location.href = 'login.html'
        })
 
        if(sessionStorage.getItem("isLoggedIn")  !=="true"){
            window.location.href = "login.html";
        }
  </script>
</body>
</html>